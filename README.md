# Documents Viewer

## Скриншоты реализации

![1.png](1.png)

## Ссылка на приложение

[Ссылка на github-pages](https://daniilmaslof.github.io/document-viewer)

### Описание решения

- Используется виртуальный скролл (**CDK Virtual Scroll**). Без него, возможно, проще использовать стандартный document viewer.
- Используется **custom virtual scroll strategy** для поддержки страниц любого размера.  
    Сейчас размеры получаются из первых 32 байт (`Range: 'bytes=0-32'`) PNG-формата.  
    Лучше, чтобы размеры страниц приходили сразу из API.
> ⚠️ **Минусы**: нужно рассчитывать размеры на бэкенде и загружать сразу все. В PNG может не быть метаинформации.

- Для **zoom** увеличиваю размер страниц и масштабирую offset скроллбара, чтобы не было сдвига.
- Для каждой страницы создаю невидимый слой аннотаций. Размер и позицию аннотаций рассчитываю в процентах для масштабирования.

  > ⚠️ **Минусы**: Проценты недостаточно точны — возможна погрешность из-за округлений.

- Для аннотаций создал **CVA** для изменения значения контрола при изменении положения (`cdk-drag-drop`).

  > ⚠️ **Минусы**: Нельзя разместить аннотацию между страницами.
- Для загрузки изображения использую диалог `input file` + drag and drop + [readDataUrlAsImage](https://github.com/daniilmaslof/document-viewer/blob/master/projects/common/src/lib/core/utils/rxjs/read-data-url-as-image.ts).
  > ⚠️ **Минусы**: Пользователь не видит сразу результат. Можно добавить cropper с отображением страницы в диалоге.


- Для сохранения создал форму следующего формата.
  ![2.png](2.png)
  > ⚠️ **Минусы**: всё, кроме аннотаций, может не изменяться — можно было бы создать просто `FormArray` для аннотаций.

- Для масштабирования `font-size` и кнопки удаления использую переменную `--scale-factor`.
### Известные проблемы
- Решена проблема со сдвигом viewport направо, когда приходит широкая страница.  
  Рассчитывается максимальная ширина документа, и заранее добавляется горизонтальный скролл.

- **Квадрирование**: если в документе много страниц формата A0, логично сразу заскейлить все страницы под viewport.  
  Предложенное решение — вычислять `squareFactor`.  
  Пока фикс закомментирован.

- Из-за `templateCacheSize` в virtual scroll и смещения аннотаций при `scale`, пришлось сделать компонент аннотации зависимым от `zoomService` для вызова `markForCheck`, чтобы аннотации не смещались.

- Проблема загрузки полноразмерных изображений в `page`, `annotations`.

  > 💡 **Решение**: добавить placeholder в base64 или загружать изображение низкого качества, а затем подгружать более качественное — например, при `scale` или остановке прокрутки.

- Масштабирование на мобильных устройствах может потребовать дополнительной доработки.

  > 💡 **Решение**: добавить что-то вроде `tuiZoom`.